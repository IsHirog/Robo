#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <LiquidCrystal_I2C.h>
#include <Servo.h> 

// --- Configuração dos LEDs do Semáforo ---
#define LED_VERMELHO 7
#define LED_AMARELO  6
#define LED_VERDE    5

// --- Constantes de Tempo do Semáforo (em milissegundos) ---
const long RED_TIME = 5000;    // 5 segundos
const long YELLOW_TIME = 2000; // 2 segundos
const long GREEN_TIME = 7000;  // 7 segundos

// --- Estados do Semáforo ---
#define STATE_RED       0
#define STATE_YELLOW_1  1 // Amarelo antes do Verde
#define STATE_GREEN     2
#define STATE_YELLOW_2  3 // Amarelo antes do Vermelho

// --- Variáveis de controle do Semáforo ---
int semaphoreState = STATE_RED;
unsigned long lastSemaphoreChange = 0; // Armazena o tempo da última mudança

// --- Configuração dos Servos Motores ---
#define SERVO_ESQUERDO_PIN 9 
#define SERVO_DIREITO_PIN 10 
Servo servoEsquerdo;
Servo servoDireito;

// --- Variáveis de controle do Servo ---
int servoPosition = 0; 
int servoDirection = 1; // 1: Crescente (0->180), -1: Decrescente (180->0)
unsigned long lastServoMove = 0; 
const long SERVO_INTERVAL = 15; // Intervalo de tempo (ms) para mover 1 grau (Controla a velocidade)

// --- Configuração OLED SSD1306 (Display Gráfico) ---
#define L 128
#define A 64
// Use o endereço correto para seu display
Adafruit_SSD1306 display(L, A, &Wire, -1);

// BITMAP GERADO (Mantenha o conteúdo da sua imagem aqui)
const unsigned char minhaImagem[] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 
  0xff, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 
  0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03, 0xff, 
  0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 
  0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 
  0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 
  0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xff, 
  0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xff, 
  0xff, 0xcf, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xfb, 0xff, 
  0xff, 0xef, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 
  0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x03, 0xff, 0xff, 
  0xff, 0xff, 0xc0, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 
  0xff, 0xff, 0xe0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 
  0xff, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x07, 0xff, 0xff, 
  0xff, 0xff, 0xf0, 0x80, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x01, 0x07, 0xff, 0xff, 
  0xff, 0xff, 0xf0, 0xe0, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0x0f, 0xff, 0xff, 
  0xff, 0xff, 0xf8, 0x7c, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3e, 0x0f, 0xff, 0xff, 
  0xff, 0xff, 0xf8, 0x3f, 0x80, 0x00, 0x1f, 0xff, 0xff, 0xfc, 0x00, 0x01, 0xfe, 0x1f, 0xff, 0xff, 
  0xff, 0xff, 0xfc, 0x3f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfc, 0x1f, 0xff, 0xff, 
  0xff, 0xff, 0xfc, 0x1f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf8, 0x3f, 0xff, 0xff, 
  0xff, 0xff, 0xfe, 0x07, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xf0, 0x7f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x80, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x01, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xe0, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x03, 0x03, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf0, 0x7f, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xfe, 0x07, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf8, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x0f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x3f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x03, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x3f, 0xff, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3f, 0xfe, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
  };

// --- Configuração LCD 16x2 I2C (Display de Caracteres) ---
LiquidCrystal_I2C lcd(0x27, 16, 2); // Verifique o endereço (0x27 ou 0x3F)

// --- DEFINIÇÕES DE CARACTERES CUSTOMIZADOS PARA O OLHO (LCD) ---
byte Olho_Sup_Esq[8] = {B01110, B10000, B10000, B10000, B10000, B10000, B10000, B10000};
byte Olho_Sup_Meio[8] = {B11111, B00000, B00000, B00000, B00000, B00000, B00000, B00000};
byte Olho_Sup_Dir[8] = {B01110, B00001, B00001, B00001, B00001, B00001, B00001, B00001};
byte Olho_Inf_Esq[8] = {B10000, B10000, B10000, B10000, B10000, B10000, B10000, B01110};
byte Olho_Inf_Pupila[8] = {B00000, B01110, B01110, B01110, B00000, B00000, B00000, B11111};
byte Olho_Inf_Dir[8] = {B00001, B00001, B00001, B00001, B00001, B00001, B00001, B01110};

// --- Funções Auxiliares do Semáforo ---
void semaforo(int vermelho, int amarelo, int verde) {
  digitalWrite(LED_VERMELHO, vermelho);
  digitalWrite(LED_AMARELO, amarelo);
  digitalWrite(LED_VERDE, verde);
}

void setup() {
  // --- Inicialização dos Periféricos ---
  // LEDs
  pinMode(LED_VERMELHO, OUTPUT);
  pinMode(LED_AMARELO, OUTPUT);
  pinMode(LED_VERDE, OUTPUT);
  semaforo(HIGH, LOW, LOW); // Começa no Vermelho

  // Servos
  servoEsquerdo.attach(SERVO_ESQUERDO_PIN);
  servoDireito.attach(SERVO_DIREITO_PIN);
  servoEsquerdo.write(servoPosition);
  servoDireito.write(180 - servoPosition);
  
  // OLED (Estático)
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { /* erro */ }
  display.clearDisplay();
  display.drawBitmap(0, 0, minhaImagem, 128, 64, SSD1306_WHITE);
  display.display(); 
  
  // LCD (Estático)
  lcd.init();
  lcd.backlight();
  lcd.createChar(0, Olho_Sup_Esq); lcd.createChar(1, Olho_Sup_Meio);
  lcd.createChar(2, Olho_Sup_Dir); lcd.createChar(3, Olho_Inf_Esq);
  lcd.createChar(4, Olho_Inf_Pupila); lcd.createChar(5, Olho_Inf_Dir);

  // Desenho do OLHO no LCD
  lcd.clear();
  int coluna_olho_esq = 4;
  int coluna_olho_dir = 8;
  lcd.setCursor(coluna_olho_esq, 0); lcd.write(byte(0)); lcd.write(byte(1)); lcd.write(byte(2));
  lcd.setCursor(coluna_olho_esq, 1); lcd.write(byte(3)); lcd.write(byte(4)); lcd.write(byte(5));
  lcd.setCursor(coluna_olho_dir, 0); lcd.write(byte(0)); lcd.write(byte(1)); lcd.write(byte(2));
  lcd.setCursor(coluna_olho_dir, 1); lcd.write(byte(3)); lcd.write(byte(4)); lcd.write(byte(5));
}

void loop() {
    unsigned long currentMillis = millis(); // Captura o tempo atual

    // ==========================================================
    // 1. LÓGICA DO SEMÁFORO (Não-bloqueante)
    // ==========================================================
    long duration = 0;
    
    // 1.1. Define a duração do estado atual
    switch (semaphoreState) {
        case STATE_RED:       duration = RED_TIME; break;
        case STATE_YELLOW_1:  duration = YELLOW_TIME; break;
        case STATE_GREEN:     duration = GREEN_TIME; break;
        case STATE_YELLOW_2:  duration = YELLOW_TIME; break;
    }

    // 1.2. Verifica se o tempo do estado atual esgotou
    if (currentMillis - lastSemaphoreChange >= duration) {
        lastSemaphoreChange = currentMillis; // Reinicia o cronômetro

        // 1.3. Transiciona para o próximo estado
        semaphoreState = (semaphoreState + 1) % 4; // Avança: 0->1->2->3->0...

        // 1.4. Atualiza os LEDs
        switch (semaphoreState) {
            case STATE_RED:      semaforo(HIGH, LOW, LOW); break;
            case STATE_YELLOW_1: semaforo(LOW, HIGH, LOW); break;
            case STATE_GREEN:    semaforo(LOW, LOW, HIGH); break;
            case STATE_YELLOW_2: semaforo(LOW, HIGH, LOW); break;
        }
    }


    // ==========================================================
    // 2. LÓGICA DOS SERVOS (Não-bloqueante)
    // ==========================================================

    // 2.1. Verifica se é hora de mover o servo um passo
    if (currentMillis - lastServoMove >= SERVO_INTERVAL) {
        lastServoMove = currentMillis; // Reinicia o cronômetro

        // 2.2. Atualiza a posição (passo de 1 grau)
        servoPosition += servoDirection;

        // 2.3. Verifica os limites (0° e 180°) e inverte a direção
        if (servoPosition >= 180) {
            servoDirection = -1; // Começa a descer
            servoPosition = 180; 
        } else if (servoPosition <= 0) {
            servoDirection = 1; // Começa a subir
            servoPosition = 0; 
        }

        // 2.4. Move os servos (Movimento oposto: pos vs 180 - pos)
        servoEsquerdo.write(servoPosition); 
        servoDireito.write(180 - servoPosition); 
    }

    // NOTA: Os displays permanecem estáticos, pois o código de desenho
    // deles está apenas na função setup(), conforme solicitado.
}